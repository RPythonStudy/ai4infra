# PostgreSQL User Name Mapping File
# [SEC-07] mTLS Certificate Identity Mapping
#
# Map Name      System User (CN in Cert)        PostgreSQL User
# -----------------------------------------------------------
# 인증서의 Common Name(CN)과 실제 DB User 이름이 미세하게 다를 경우 매핑
# 예: CN=keycloak.ai4infra.internal -> DB User=keycloak

# 1. Self Mapping (Default)
# CN이 DB 유저명과 정확히 일치하거나, 도메인 형태일 때 앞부분만 매칭시키는 등의 규칙 필요
# 하지만 cert 인증 방식에서는 pg_hba.conf의 map 옵션이 없으면 CN == DB User 여야 함.
# 여기서는 와일드카드를 써서 유연하게 허용하거나, 명시적으로 매핑함.

# Syntax: map-name  system-username  database-username

# Rule A: Exact Match (기본)
mtls_map    /^(.*)$    \1

# Rule B: Domain Strip (CN=postgres.ai4infra.internal -> postgres)
mtls_map    /^([^\.]+)\.ai4infra\.internal$    \1

# Rule C: Service Specific
mtls_map    ai4infra-keycloak    keycloak
mtls_map    ai4infra-vault       vault
mtls_map    keycloak             keycloak
mtls_map    vault                vault
